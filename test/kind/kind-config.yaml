kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
name: kmsv2-test-cluster
nodes:
  - role: control-plane
    extraMounts:
      - hostPath: /tmp/kagimori/encryption
        containerPath: /etc/kubernetes/encryption
    kubeadmConfigPatches:
      - |
        apiVersion: kubeadm.k8s.io/v1beta3
        kind: ClusterConfiguration
        apiServer:
          extraArgs:
            encryption-provider-config: /etc/kubernetes/encryption/config.yaml
            encryption-provider-config-automatic-reload: "true"
          extraVolumes:
            - name: encryption-config
              hostPath: /etc/kubernetes/encryption
              mountPath: /etc/kubernetes/encryption
              pathType: Directory
              readOnly: true
            - name: socket-kagimori
              hostPath: /var/run/kagimori
              mountPath: /var/run/kagimori
              pathType: DirectoryOrCreate
        podSpecs:
          - name: kagimori-kms
            image: ghcr.io/kinorca/kagimori:latest
            command:
              - /usr/local/bin/kagimori
              - --listen=unix:///var/run/kagimori/kagimori.sock
              - --kms-v2
              - --master-key=/etc/kagimori/keys/master-key.yaml
            volumeMounts:
              - name: socket-kagimori
                hostPath: /var/run/kagimori
                mountPath: /var/run/kagimori
                pathType: Directory

